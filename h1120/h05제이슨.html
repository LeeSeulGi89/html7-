<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <title>학생성적프로그램</title>
    <style>
        table,th,td{border:1px solid black; border-collapse: collapse;}
        th,td{width:100px; height:40px; text-align: center; }
    </style>
    <script>
        // 자바스크립트 구문이 너무 길고 복잡해질 경우 전역변수를 활용하여 관리하는 것이 좋다.

        var studentData = []; // 전역 변수로 데이터 저장
        
        $(function(){  //jquery start
            // 데이터 가져오기
            $("#takeBtn").click(function(){   
                $.ajax({    
                    url:"공부.json",  
                    type:"get",   
                    data:{},  
                    dataType:"json",  
                    success:function(data){    
                        alert("성공");   
                        console.log(data);  
                        studentData = data; // 전역에 데이터 저장
                        displayData();
                    },
                    error:function(){ alert("실패");  }  
                });
            });
            
            // 성적 저장 버튼
            $("#sbtn").click(function(){
                saveBtn();
            });
            
            // 수정 버튼 이벤트 (위임 이벤트)
            $(document).on('click', '.uBtn', function(){
                updateBtn(this);
            });
            
            // 삭제 버튼 이벤트 (위임 이벤트)
            $(document).on('click', '.dBtn', function(){
                deleteBtn(this);
            }); // ajax end
        }); // jquery end
        
        // 데이터 표시 함수
        function displayData(){
            var dataHtml = ``;
            for(var i=0; i<studentData.length; i++){  
                var total = studentData[i].kor + studentData[i].eng + studentData[i].math;
                var avg = (total / 3).toFixed(1);
                dataHtml += `
                    <tr id="${studentData[i].sno}">
                        <td>${studentData[i].sno}</td>
                        <td>${studentData[i].name}</td>
                        <td>${studentData[i].kor}</td>
                        <td>${studentData[i].eng}</td>
                        <td>${studentData[i].math}</td>
                        <td>${total}</td>
                        <td>${avg}</td>
                        <td>
                            <button type="button" class="uBtn">수정</button>
                            <button type="button" class="dBtn">삭제</button>
                        </td>
                    </tr>
                `;
            }
            $("#tbody").html(dataHtml);  
        }
        
        // 성적 저장 함수
        function saveBtn(){
            var sno = parseInt($("#sno").val());
            var name = $("#name").val();
            var kor = parseInt($("#kor").val());
            var eng = parseInt($("#eng").val());
            var math = parseInt($("#math").val());
            
            // 입력 값 검증
            if(!sno || !name || isNaN(kor) || isNaN(eng) || isNaN(math)){
                alert("모든 항목을 올바르게 입력해주세요.");
                return;
            }
            
            if(kor < 0 || kor > 100 || eng < 0 || eng > 100 || math < 0 || math > 100){
                alert("점수는 0~100 사이로 입력해주세요.");
                return;
            }
            
            // 중복 번호 확인
            var exists = studentData.find(student => student.sno === sno);
            if(exists){
                alert("이미 존재하는 번호입니다.");
                return;
            }
            
            // 새 데이터 추가
            var newStudent = {
                sno: sno,
                name: name,
                kor: kor,
                eng: eng,
                math: math
            };
            
            studentData.push(newStudent);
            displayData();
            clearForm();
            alert("성적이 저장되었습니다.");
        }
        
        // 엔터키 처리 함수
        function enterBtn(event){
            if(event.keyCode === 13){
                saveBtn();
            }
        }
        
        // 수정 버튼 함수
        function updateBtn(btn){
            var row = $(btn).closest('tr');
            var sno = parseInt(row.attr('id'));
            var studentIndex = studentData.findIndex(student => student.sno === sno);
            
            if(studentIndex !== -1){
                var student = studentData[studentIndex];
                $("#sno").val(student.sno);
                $("#name").val(student.name);
                $("#kor").val(student.kor);
                $("#eng").val(student.eng);
                $("#math").val(student.math);
                
                // 데이터 삭제 후 다시 저장하도록 안내
                studentData.splice(studentIndex, 1);
                displayData();
                alert("수정할 데이터를 불러왔습니다. 수정 후 다시 저장해주세요.");
            }
        }
        
        // 삭제 버튼 함수
        function deleteBtn(btn){
            if(confirm("정말 삭제하시겠습니까?")){
                var row = $(btn).closest('tr');
                var sno = parseInt(row.attr('id'));
                var studentIndex = studentData.findIndex(student => student.sno === sno);
                
                if(studentIndex !== -1){
                    studentData.splice(studentIndex, 1);
                    displayData();
                    alert("삭제되었습니다.");
                }
            }
        }
        
        // 폼 초기화 함수
        function clearForm(){
            $("#sno").val("");
            $("#name").val("");
            $("#kor").val("");
            $("#eng").val("");
            $("#math").val("");
        }
    </script>
</head>
<body>
    <button type="button" id="takeBtn">데이터 가져오기</button>
    <form action="#" method="get">
        <label>번호</label>
        <input type="text" id="sno" name="sno"><br>
        <label>이름</label>
        <input type="text" id="name" name="name"><br>
        <label>국어</label>
        <input type="text" id="kor" name="kor"><br>
        <label>영어</label>
        <input type="text" id="eng" name="eng"><br>
        <label>수학</label>
        <input type="text" id="math" name="math" onkeyup="enterBtn(event)" ><br>
        <button type="button" id="sbtn">성적저장</button>
    </form>
    <table>
        <tr>
            <th>번호</th>
            <th>이름</th>
            <th>국어</th>
            <th>영어</th>
            <th>수학</th>
            <th>합계</th>
            <th>평균</th>
            <th>비고</th>
        </tr>
        <tbody id="tbody">
           
            
        </tbody>

    </table>
   
   
</body>
</html>